var W=Object.defineProperty;var J=(s,t,e)=>t in s?W(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var r=(s,t,e)=>(J(s,typeof t!="symbol"?t+"":t,e),e);import{h as X}from"./vendor.ac3731c2.js";const j=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerpolicy&&(a.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?a.credentials="include":o.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}};j();const g=2*Math.PI;function _(s){return Math.sqrt(s.x*s.x+s.y*s.y)}const E=document.getElementById("game-canvas"),n=E.getContext("2d");function B(){n.imageSmoothingEnabled=!1}const x=window.devicePixelRatio?window.devicePixelRatio:1;n.scale(x,x);n.save();n.width=E.clientWidth;n.height=E.clientHeight;let T=0;function b(){const s=performance.now();if(s-T<10)return;T=s,console.log("resize");const t=window.innerWidth,e=window.innerHeight,i=n.width/n.height,o=t/e;let a=1;o>=i?a=e/n.height:a=t/n.width,a>1&&(a=Math.floor(a)),E.width=n.width*a*x,E.height=n.height*a*x,E.style.width=`${n.width*a}px`,E.style.height=`${n.height*a}px`,n.restore(),n.save(),n.scale(a*x,a*x),B()}window.addEventListener("resize",b);n.setGameSize=function(s,t){this.width=s,this.height=t,b()};n.clear=function(s){this.fillStyle=s,this.clearRect(0,0,n.width,n.height),this.fillRect(0,0,n.width,n.height)};n.drawLine=function(s,t,e,i){this.beginPath(),this.moveTo(s,t),this.lineTo(e,i),this.closePath(),this.stroke()};n.drawCircle=function(s,t,e){this.beginPath(),this.arc(s,t,e,0,g),this.closePath(),this.stroke()};n.fillCircle=function(s,t,e){this.beginPath(),this.arc(s,t,e,0,g),this.closePath(),this.fill()};n.tintTexture=function(s,t){const e=document.createElement("canvas");e.width=s.width,e.height=s.height;const i=e.getContext("2d");i.drawImage(s,0,0),i.globalCompositeOperation="source-in",i.fillStyle=t,i.fillRect(0,0,e.width,e.height);const o=e.toDataURL(),a=new Image(e.width,e.height);return a.src=o,i.globalCompositeOperation="source-in",a};const P={Space:"space",Enter:"enter",ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",KeyW:"w",KeyA:"a",KeyS:"s",KeyD:"d",KeyQ:"q",KeyE:"e",Digit1:"one",Digit2:"two",Digit3:"three",Digit4:"four",Digit5:"five"};class G{constructor(){r(this,"mouseX",0);r(this,"mouseY",0);r(this,"keys",{});r(this,"mouseButton",[!1,!1]);for(const t in P)this.keys[P[t]]=[!1,!1];window.addEventListener("keydown",t=>{t.preventDefault();const e=P[t.code];e&&(this.keys[e][0]=!0)}),window.addEventListener("keyup",t=>{t.preventDefault();const e=P[t.code];e&&(this.keys[e][0]=!1)}),n.canvas.addEventListener("mousemove",t=>{t.preventDefault();const e=n.width/n.canvas.clientWidth,i=n.canvas.getClientRects()[0];return this.mouseX=(t.clientX-i.x)*e,this.mouseY=(t.clientY-i.y)*e,!1}),n.canvas.addEventListener("mousedown",t=>(t.preventDefault(),t.button===0&&(this.mouseButton[0]=!0),!1)),n.canvas.addEventListener("mouseup",t=>(t.preventDefault(),t.button===0&&(this.mouseButton[0]=!1),!1))}newFrame(){for(const t in this.keys)this.keys[t][1]=this.keys[t][0];this.mouseButton[1]=this.mouseButton[0]}mouseIsPressed(){return!!this.mouseButton[0]}mouseIsJustPressed(){return!!(this.mouseButton[0]&&!this.mouseButton[1])}mouseIsJustReleased(){return!!(!this.mouseButton[0]&&this.mouseButton[1])}keyIsPressed(...t){if(t.length>0){for(let e=0;e<t.length;++e)if(this.keys[t[e]][0])return!0}else for(const e in this.keys)if(this.keys[e][0])return!0;return!1}keyIsJustPressed(...t){if(t.length>0){for(let e=0;e<t.length;++e)if(this.keys[t[e]][0]&&!this.keys[t[e]][1])return!0}else for(const e in this.keys)if(this.keys[e][0]&&!this.keys[e][1])return!0;return!1}keyIsJustReleased(...t){if(t.length>0){for(let e=0;e<t.length;++e)if(!this.keys[t[e]][0]&&this.keys[t[e]][1])return!0}else for(const e in this.keys)if(!this.keys[e][0]&&this.keys[e][1])return!0;return!1}}const p=new G;class q{constructor(){r(this,"time",0);r(this,"slowdown",1);r(this,"dt",1/60)}deltaTime(){return this.dt*this.slowdown}}const m=new q;class K{constructor(t,e){r(this,"loopTimerID",0);r(this,"lastFrameTime");r(this,"states",[]);r(this,"shouldCallResume",!1);r(this,"resumeArgs");n.setGameSize(t,e),this.lastFrameTime=performance.now()}run(t){this.states.push(t),this.states[this.states.length-1].start(),this.update()}quit(){var t;do(t=this.states.pop())==null||t.end();while(this.states.length>0);window.cancelAnimationFrame(this.loopTimerID),document.removeChild(n.canvas)}pushState(t,e){this.states[this.states.length-1].pause(),this.states.push(t),this.shouldCallResume=!1,t.start(e)}popState(t){var e;this.states.length>1?((e=this.states.pop())==null||e.end(),this.shouldCallResume=!0,this.resumeArgs=t):console.error("Trying to pop the last game state of the state stack!")}peekState(){return this.states[this.states.length-1]}update(){this.loopTimerID=window.requestAnimationFrame(()=>this.update());const t=performance.now(),e=(t-this.lastFrameTime)/1e3;m.dt=e,m.time+=e,this.shouldCallResume&&(this.shouldCallResume=!1,this.states[this.states.length-1].resume(this.resumeArgs)),this.states[this.states.length-1].update(),n.clear("black");for(const i of this.states)i.draw();this.lastFrameTime=t,p.newFrame()}}class M{start(t){}end(){}resume(t){}pause(){}update(){}draw(){}}class V{constructor(){r(this,"clips");this.clips={},this.load("menu","./res/audio/music/menu.mp3",!0),this.load("pee","./res/audio/sfx/pee.mp3",!1),this.load("battle","./res/audio/music/battle.mp3",!0),this.load("deaf","./res/audio/sfx/deaf.mp3",!1),this.load("shield_up","./res/audio/sfx/shield_up.mp3",!1)}load(t,e,i,o=1){const a=new X.Howl({src:e,loop:i,volume:o});this.clips[t]=a}play(t,e=1){this.clips[t].volume(e),this.clips[t].play()}fadeOut(t,e){const i=this.clips[t];i.fade(i.volume(),0,e),i.on("fade",()=>{i.stop()})}}const y=new V;var h;(function(s){s[s.INVALID_TYPE=0]="INVALID_TYPE",s[s.PEAPROJECTILE=1]="PEAPROJECTILE",s[s.ENEMY=2]="ENEMY",s[s.SHADOW=3]="SHADOW",s[s.HURTABLE=4]="HURTABLE",s[s.TILEMAP=5]="TILEMAP",s[s.ANIMATOR=6]="ANIMATOR",s[s.COLLIDER=7]="COLLIDER",s[s.MOVER=8]="MOVER",s[s.TEXT=9]="TEXT",s[s.PLAYER=10]="PLAYER",s[s.UPGRADE=11]="UPGRADE",s[s.STATS=12]="STATS",s[s.CHEF=13]="CHEF",s[s.NUM_TYPES=14]="NUM_TYPES"})(h||(h={}));class f{constructor(t,e){r(this,"type",0);r(this,"active",!0);r(this,"entity");this.entity=t,this.type=e}awake(){}update(){}render(){}destroy(){}get world(){return this.entity.world}}const Y={},S={};function z(s,t){return new Promise((e,i)=>{const o=new Image;o.onload=()=>{Y[s]=o,e(o)},o.onerror=()=>{i(t)},o.src=t})}function $(s){return new Promise((t,e)=>{if(s.length===0){t();return}const i=[];s.forEach(o=>{i.push(z(o[0],o[1]))}),Promise.all(i).then(()=>{t()}).catch(o=>{e(o)})})}function Q(s){return new Promise((t,e)=>{fetch(s,{method:"GET"}).then(i=>i.json()).then(i=>{t(i)}).catch(i=>{console.error(`Failed to load "${s}": ${i}`),e()})})}function C(s){return new Promise((t,e)=>{Q(s).then(i=>{for(const o in i)S[o]=i[o];t(S)}).catch(()=>{e()})})}class I extends f{constructor(t,e,i){super(i,h.ANIMATOR);r(this,"xOffset",0);r(this,"yOffset",0);r(this,"img");r(this,"sprite");r(this,"frameIndex",0);r(this,"frameTime",0);r(this,"current");r(this,"currentAnim");r(this,"columns");this.sprite=t,this.img=Y[t.image],console.assert(this.img!==void 0,"Failed to load image for animation"),this.columns=this.sprite.width/this.sprite.frameWidth|0,this.current=e,this.currentAnim=this.sprite.anims[this.current]}play(t){t!==this.current&&(this.current=t,this.currentAnim=this.sprite.anims[t],this.frameTime=0,this.frameIndex=0)}awake(){this.frameIndex=0,this.frameTime=0}update(){const t=m.deltaTime()*1e3;for(this.frameTime+=t;this.frameTime>=this.currentAnim.framedurations[this.frameIndex];)this.frameTime-=this.currentAnim.framedurations[this.frameIndex],this.frameIndex+=1,this.frameIndex>=this.currentAnim.framedurations.length&&(this.frameIndex=0)}render(){if(this.entity.visible){const t=this.currentAnim.start+this.frameIndex,e=t%this.columns*this.sprite.frameWidth,i=(t/this.columns|0)*this.sprite.frameHeight;n.drawImage(this.img,e,i,this.sprite.frameWidth,this.sprite.frameHeight,this.entity.position.x+this.xOffset,this.entity.position.y+this.yOffset,this.sprite.frameWidth,this.sprite.frameHeight)}}}class A extends f{constructor(t,e,i){super(i,h.COLLIDER);r(this,"mask");r(this,"radius");r(this,"debugDraw",!1);this.radius=t,this.mask=e}render(){this.debugDraw&&(n.strokeStyle="red",n.drawCircle(this.entity.position.x,this.entity.position.y,this.radius))}collidesAt(t,e,i){return this.firstCollisionAt(t,e,i)!==null}firstCollisionAt(t,e,i){for(const o of this.world.all(h.COLLIDER))if((o.mask&t)!=0&&this.collidesWithAt(o,e,i))return o;return null}allCollisionsAt(t,e,i){const o=[];for(const a of this.world.all(h.COLLIDER))(a.mask&t)!=0&&this.collidesWithAt(a,e,i)&&o.push(a);return o}collidesWithAt(t,e,i){const o=this.entity.position.x+e-t.entity.position.x,a=this.entity.position.y+i-t.entity.position.y,l=o*o+a*a,u=this.radius+t.radius;return l<=u*u}}class k extends f{constructor(t){super(t,h.ENEMY)}}class L extends f{constructor(t,e,i){super(i,h.HURTABLE);r(this,"hurtBy");r(this,"collider");r(this,"onHurt");this.hurtBy=e,this.onHurt=t,this.collider=this.entity.first(h.COLLIDER)}update(){this.collider.collidesAt(this.hurtBy,0,0)&&(this.onHurt?this.onHurt():this.world.destroyEntity(this.entity))}}var d;(function(s){s[s.NONE=0]="NONE",s[s.SOLID=1]="SOLID",s[s.PLAYER=4]="PLAYER",s[s.ENEMY=8]="ENEMY",s[s.PLAYER_PROJECTILE=16]="PLAYER_PROJECTILE",s[s.ENEMY_PROJECTILE=32]="ENEMY_PROJECTILE",s[s.UPGRADE=64]="UPGRADE"})(d||(d={}));class Z extends f{constructor(t,e){super(e,h.MOVER);r(this,"inputx",0);r(this,"inputy",0);r(this,"speed",64);r(this,"xError",0);r(this,"yError",0);r(this,"speedModifier",1);r(this,"collider");r(this,"onCollisionX");r(this,"onCollisionY");this.speed=t}update(){const t=m.deltaTime();let e=this.inputx,i=this.inputy;if(Math.abs(e)+Math.abs(i)>1){const o=Math.sqrt(e*e+i*i);e/=o,i/=o}this.moveX(e*this.speed*this.speedModifier*t),this.moveY(i*this.speed*this.speedModifier*t)}moveX(t){if(this.collider){if(this.xError+=t,t=Math.round(this.xError),Math.abs(t)>0){const e=Math.sign(t);for(;t!==0;){if(this.collider.collidesAt(d.SOLID,e,0)){this.onCollisionX?this.onCollisionX(this):this.stopX();break}this.entity.position.x+=e,t-=e,this.xError-=e}}}else this.entity.position.x+=t}moveY(t){if(this.collider){if(this.yError+=t,t=Math.round(this.yError),Math.abs(t)>0){const e=Math.sign(t);for(;t!==0;){if(this.collider.collidesAt(d.SOLID,0,e)){this.onCollisionY?this.onCollisionY(this):this.stopY();break}this.entity.position.y+=e,t-=e,this.xError-=e}}}else this.entity.position.y+=t}setSpeedModifier(t){this.speedModifier=t}stopX(){this.xError=0}stopY(){this.xError=0}}class tt extends f{constructor(t,e){super(e,h.PEAPROJECTILE);r(this,"dx",0);r(this,"dy",0);r(this,"color");this.color=t,y.play("pee")}update(){const t=m.deltaTime();this.entity.position.x+=this.dx*t,this.entity.position.y+=this.dy*t,_(this.entity.position)>256&&this.world.destroyEntity(this.entity)}render(){n.fillStyle=this.color,n.fillCircle(this.entity.position.x,this.entity.position.y,2)}}class et extends f{constructor(t){super(t,h.PLAYER);r(this,"mover");r(this,"animator");r(this,"chef");r(this,"weaponCooldown",0);r(this,"firedWeapon",!1);this.mover=this.entity.first(h.MOVER),this.animator=this.entity.first(h.ANIMATOR),this.chef=this.entity.first(h.CHEF)}update(){if(this.chef.dying)this.mover.inputx=this.mover.inputy=0;else{const t=this.world.screenToWorld(p.mouseX,p.mouseY),e=t[0]-this.entity.position.x,i=t[1]-this.entity.position.y;this.entity.rotation=Math.atan2(i,e)+g/4,this.mover.inputx=this.mover.inputy=0,p.keyIsPressed("up","w")&&(this.mover.inputy-=1),p.keyIsPressed("down","s")&&(this.mover.inputy+=1),p.keyIsPressed("left","a")&&(this.mover.inputx-=1),p.keyIsPressed("right","d")&&(this.mover.inputx+=1),this.firedWeapon=!1,this.weaponCooldown<=0?p.mouseIsJustPressed()&&(this.chef.fire(),this.firedWeapon=!0):this.weaponCooldown-=m.deltaTime(),Math.abs(this.mover.inputx)+Math.abs(this.mover.inputy)>0?this.chef.animationState="move weapon1":this.chef.animationState="stand weapon1"}}}class it extends f{constructor(t,e){super(e,h.UPGRADE);r(this,"collider");r(this,"upgradeType");this.collider=this.entity.first(h.COLLIDER),this.upgradeType=t}update(){this.collider.collidesAt(d.PLAYER,0,0)&&(this.world.first(h.PLAYER).chef.takeUpgrade(this.upgradeType),this.world.destroyEntity(this.entity))}}class st extends f{constructor(t){super(t,h.SHADOW);r(this,"startX");r(this,"startY");r(this,"chef");this.startX=this.entity.position.x,this.startY=this.entity.position.y,this.chef=this.entity.first(h.CHEF)}}class D{constructor(){r(this,"shield",0);r(this,"speedModifier",1);r(this,"projectileSpeedModifier",1);r(this,"damageModifer",1);r(this,"slowOnHit",0);r(this,"stunChance",0);r(this,"invulnerabilityTime",0);r(this,"weaponSpreadModifier",1);r(this,"weaponCooldownModifier",1);r(this,"explosionDelay",0);r(this,"doubleShotChance",0);r(this,"explosionRangeModifier",1)}}class O extends f{constructor(t){super(t,h.STATS);r(this,"stats");this.stats=new D}apply(t){this.stats.shield+=t.shield,this.stats.speedModifier*=t.speedModifier,this.stats.projectileSpeedModifier*=t.projectileSpeedModifier,this.stats.damageModifer*=t.damageModifer,this.stats.slowOnHit+=t.slowOnHit,this.stats.stunChance+=t.stunChance,this.stats.invulnerabilityTime+=t.invulnerabilityTime,this.stats.weaponSpreadModifier*=t.weaponSpreadModifier,this.stats.weaponCooldownModifier*=t.weaponCooldownModifier,this.stats.explosionDelay+=t.explosionDelay,this.stats.doubleShotChance+=t.doubleShotChance,this.stats.explosionRangeModifier*=t.explosionRangeModifier,this.onApply()}onApply(){var t;(t=this.entity.first(h.MOVER))==null||t.setSpeedModifier(this.stats.speedModifier)}render(){this.stats.shield>0&&(n.strokeStyle="blue",n.drawCircle(this.entity.position.x,this.entity.position.y,8))}}class N{constructor(t,e){r(this,"name","crate");r(this,"animation","stand");r(this,"stats");r(this,"type");this.stats=this.setStats(t,e),this.type=t}setStats(t,e){let i=new D;switch(t){case c.shield:i.shield=e;case c.speed:i.speedModifier=e;case c.projectileSpeed:i.projectileSpeedModifier=e;case c.damage:i.damageModifer=e;case c.slow:i.slowOnHit=e;case c.stun:i.stunChance=e;case c.invulnerability:i.invulnerabilityTime=e;case c.weaponSpread:i.weaponSpreadModifier=e;case c.weaponCooldown:i.weaponCooldownModifier=e;case c.explosionDelay:i.explosionDelay=e;case c.doubleShot:i.doubleShotChance=e;case c.explosionRange:i.explosionRangeModifier=e}return i}}var c;(function(s){s[s.shield=0]="shield",s[s.speed=1]="speed",s[s.projectileSpeed=2]="projectileSpeed",s[s.damage=3]="damage",s[s.slow=4]="slow",s[s.stun=5]="stun",s[s.invulnerability=6]="invulnerability",s[s.weaponSpread=7]="weaponSpread",s[s.weaponCooldown=8]="weaponCooldown",s[s.explosionDelay=9]="explosionDelay",s[s.doubleShot=10]="doubleShot",s[s.explosionRange=11]="explosionRange"})(c||(c={}));class rt{constructor(t){r(this,"world");r(this,"cooldown",.1);this.world=t}fire(t,e,i,o){t+=Math.cos(i-g/4)*8,e+=Math.sin(i-g/4)*8,nt(t,e,i,128,o,this.world)}}class H extends f{constructor(t,e){super(e,h.CHEF);r(this,"animator");r(this,"weapon");r(this,"dying",!1);r(this,"animationState");r(this,"projectileMask");r(this,"upgradeType");this.projectileMask=t,this.animator=this.entity.first(h.ANIMATOR),this.weapon=new rt(this.world),this.animationState="stand weapon1"}fire(){this.weapon.fire(this.entity.position.x,this.entity.position.y,this.entity.rotation,this.projectileMask)}takeUpgrade(t){this.upgradeType=t,this.playUpgradeSfx(t.type),this.entity.first(h.STATS).apply(t.stats)}playUpgradeSfx(t){switch(t){case c.shield:y.play("shield_up")}}getUpgrade(){if(this.upgradeType){const t=this.upgradeType;return this.upgradeType=void 0,t}}update(){this.dying?(this.animator.play("death"),this.animator.frameIndex===2&&this.animator.frameTime>=50&&this.world.destroyEntity(this.entity)):this.animator.play(this.animationState)}}function ot(s,t,e){const i=e.addEntity(s,t);i.add(new A(6,d.PLAYER,i)),i.add(new Z(64,i));const o=i.add(new O(i)),a=i.add(new I(S.maincharacter,"stand weapon1",i));a.xOffset=-16,a.yOffset=-21;const l=()=>{o.stats.shield>0?o.stats.shield--:(u.chef.dying||y.play("deaf"),u.chef.dying=!0)};i.add(new L(l,d.ENEMY|d.ENEMY_PROJECTILE,i)),i.add(new H(d.PLAYER_PROJECTILE,i));const u=i.add(new et(i));return i}function nt(s,t,e,i,o,a){const l=a.addEntity(s,t),u=o===d.PLAYER_PROJECTILE?"lime":"#bc90da",R=l.add(new tt(u,l));return e-=g/4,R.dx=Math.cos(e)*i,R.dy=Math.sin(e)*i,l.add(new A(2,o,l)),o===d.PLAYER_PROJECTILE?d.ENEMY|d.PLAYER:d.PLAYER,l.add(new L(null,d.PLAYER,l)),l}function at(s,t,e){const i=e.addEntity(s,t);i.add(new A(8,d.ENEMY,i));const o=i.add(new I(S.slime,"move",i));return o.xOffset=-8,o.yOffset=-8,i.add(new L(null,d.PLAYER_PROJECTILE,i)),i.add(new k(i)),i}function ht(s,t,e,i){const o=i.addEntity(s,t);o.add(new O(o));const a=o.add(new I(S[e.name],e.animation,o));return o.add(new A(8,d.UPGRADE,o)),o.add(new it(e,o)),a.xOffset=-8,a.yOffset=-8,o}function lt(s,t,e){const i=e.addEntity(s,t);i.rotation=g/2,i.add(new A(6,d.ENEMY,i));const o=i.add(new O(i)),a=i.add(new I(S.maincharactershadow,"stand weapon1",i));a.xOffset=-16,a.yOffset=-21;const l=()=>{o.stats.shield>0?o.stats.shield--:(u.dying||y.play("deaf"),u.dying=!0)};i.add(new L(l,d.PLAYER_PROJECTILE,i)),i.add(new k(i));const u=i.add(new H(d.ENEMY_PROJECTILE,i));return i.add(new st(i)),i}class dt{constructor(t,e,i,o,a,l){r(this,"x");r(this,"y");r(this,"rotation");r(this,"animationState");r(this,"upgrade");r(this,"shoot",!1);this.x=t,this.y=e,this.rotation=i,this.animationState=o,this.upgrade=a,this.shoot=l}}class ct{constructor(){r(this,"recordings",[]);r(this,"currentIndex",0);r(this,"backwards",!1);r(this,"firstPlayback",!0)}add(t){this.recordings.length<3600&&this.recordings.push(t)}get(t){return this.recordings[t]}getNext(){const t=this.recordings[this.currentIndex];return this.backwards?(this.currentIndex--,this.currentIndex==0&&(this.backwards=!1)):(this.currentIndex++,this.currentIndex==this.recordings.length-1&&(this.firstPlayback=!1,this.backwards=!0)),t}}class ut{constructor(t){r(this,"active",!0);r(this,"world");r(this,"position",{x:0,y:0});r(this,"rotation",0);r(this,"visible",!0);r(this,"components",[]);this.world=t}first(t){for(const e of this.components)if(e.type===t)return e;return null}add(t){return this.components.push(t),this.world.add(t),t}}class ft{constructor(){r(this,"entities",new Array);r(this,"components");r(this,"cameraX",0);r(this,"cameraY",0);this.components=[];for(let t=1;t<h.NUM_TYPES;++t)this.components.push([])}update(){for(const t of this.components)for(const e of t)e.active&&e.entity.active&&e.update()}render(){n.save(),n.translate(n.width/2-this.cameraX,n.height/2-this.cameraY),n.strokeStyle="white",n.drawCircle(0,0,64);for(const t of this.components)for(const e of t)e.active&&e.entity.active&&(n.save(),e.entity.rotation!==0&&(n.translate(e.entity.position.x,e.entity.position.y),n.rotate(e.entity.rotation),n.translate(-e.entity.position.x,-e.entity.position.y)),e.render(),n.restore());n.restore()}screenToWorld(t,e){return[t-n.width/2+this.cameraX,e-n.height/2+this.cameraY]}worldToScreen(t,e){return[t+n.width/2-this.cameraX,e+n.height/2-this.cameraY]}addEntity(t,e){const i=new ut(this);return i.position={x:t,y:e},this.entities.push(i),i}destroyEntity(t){t.active=!1;for(const e of t.components)this.destroy(e);for(let e=0;e<this.entities.length;++e)if(this.entities[e]===t){this.entities.splice(e,1);break}}first(t){return this.components[t].length>0?this.components[t-1][0]:null}all(t){return this.components[t-1]}add(t){return this.components[t.type-1].push(t),t.awake(),t}destroy(t){const e=this.components[t.type-1];for(let i=0;i<e.length;++i)if(e[i]===t){e.splice(i,1);break}t.destroy()}}class pt extends M{constructor(t,e){super();r(this,"duration");r(this,"t",0);r(this,"onFadeComplete");this.duration=t,this.onFadeComplete=e}update(){this.t+=m.deltaTime(),this.t>=this.duration&&(w.popState(),this.onFadeComplete&&this.onFadeComplete())}draw(){n.fillStyle=`rgba(0, 0, 0, ${this.t/this.duration}`,n.fillRect(0,0,n.width,n.height)}}class mt extends M{constructor(t){super();r(this,"duration");r(this,"t",0);this.duration=t}update(){this.t+=m.deltaTime(),this.t>=this.duration&&w.popState()}draw(){n.fillStyle=`rgba(0, 0, 0, ${1-this.t/this.duration}`,n.fillRect(0,0,n.width,n.height)}}class yt{constructor(){r(this,"upgradesTypes",[]);this.upgradesTypes.push(new N(c.speed,1.2)),this.upgradesTypes.push(new N(c.shield,1))}getRandomUpgrade(){const t=Math.floor(Math.random()*this.upgradesTypes.length);return this.upgradesTypes[t]}}class v extends M{constructor(t,e){super();r(this,"world");r(this,"player");r(this,"currentLevel",0);r(this,"recordings",[]);r(this,"shadows",[]);r(this,"currentRecording");r(this,"upgradeArray");r(this,"timer",60);if(this.world=new ft,this.player=ot(0,0,this.world).first(h.PLAYER),this.currentLevel=t,this.recordings=e,this.currentRecording=new ct,this.upgradeArray=new yt,t===0)at(0,-32,this.world);else{let i=0;for(let a=0;a<e.length;++a)i+=e.length-a,this.shadows.push([]);let o=32*e.length;for(let a=0;a<e.length;++a){const l=e.length-a;let u=0;for(let R=0;R<l;++R){const U=Math.cos(u)*o,F=Math.sin(u)*o;this.shadows[a].push(lt(U,F,this.world).first(h.SHADOW)),u+=g/l}o-=32}}ht(0,32,this.upgradeArray.getRandomUpgrade(),this.world),console.log(t)}update(){if(!this.player.entity.active){w.popState();return}for(let e=0;e<this.recordings.length;++e){const i=this.recordings[e].getNext();for(const o of this.shadows[e])o.entity.active&&(o.entity.position.x=o.startX+i.x,o.entity.position.y=o.startY+i.y,o.chef.animationState=i.animationState,o.entity.rotation=i.rotation,this.recordings[e].firstPlayback&&i.upgrade&&o.chef.takeUpgrade(i.upgrade),i.shoot&&o.chef.fire())}this.world.update(),this.world.cameraX=this.player.entity.position.x,this.world.cameraY=this.player.entity.position.y;let t=this.player.chef.getUpgrade();this.currentRecording.add(new dt(this.player.entity.position.x,this.player.entity.position.y,this.player.entity.rotation,this.player.animator.current,t||null,this.player.firedWeapon)),this.world.all(h.ENEMY).length===0&&this.onNewLevel(),this.timer-=m.deltaTime(),this.timer<0&&(this.player.entity.first(h.CHEF).dying=!0)}draw(){n.fillStyle="white",n.fillText(Math.max(Math.floor(this.timer),0).toString(),n.width/10,n.height/10),this.world.render()}onNewLevel(){this.recordings.push(this.currentRecording),w.pushState(new pt(1,()=>{w.popState(),w.pushState(new v(++this.currentLevel,this.recordings)),w.pushState(new mt(1))}))}}class wt extends M{constructor(){super();r(this,"starting",!1);y.play("menu")}update(){p.mouseIsJustPressed()&&(this.starting=!0,w.pushState(new v(0,[])),y.fadeOut("menu",500),y.play("battle",.7))}draw(){this.starting?n.clear("black"):(n.fillStyle="white",n.fillText("Click to start",n.width/2,n.height/2))}resume(t){this.starting=!1,y.fadeOut("battle",500),y.play("menu")}}const w=new K(200,600/4),gt=[$([["crate","./res/crate.png"],["cthulhupotato","./res/cthulhupotato.png"],["maincharacter","./res/maincharacter.png"],["maincharactershadow","./res/maincharactershadow.png"],["pickups","./res/pickups.png"],["slime","./res/slime.png"]]),C("./res/sprites.json"),C("./res/sprites_shadow.json")];Promise.all(gt).then(s=>{w.run(new wt)});
