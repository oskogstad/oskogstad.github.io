var J=Object.defineProperty;var X=(i,t,e)=>t in i?J(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var r=(i,t,e)=>(X(i,typeof t!="symbol"?t+"":t,e),e);import{h as _}from"./vendor.5b7e8339.js";const B=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerpolicy&&(a.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?a.credentials="include":o.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}};B();const E=2*Math.PI;function G(i){return Math.sqrt(i.x*i.x+i.y*i.y)}const x=document.getElementById("game-canvas"),n=x.getContext("2d");function q(){n.imageSmoothingEnabled=!1}const S=window.devicePixelRatio?window.devicePixelRatio:1;n.scale(S,S);n.save();n.width=x.clientWidth;n.height=x.clientHeight;let Y=0;function k(){const i=performance.now();if(i-Y<10)return;Y=i,console.log("resize");const t=window.innerWidth,e=window.innerHeight,s=n.width/n.height,o=t/e;let a=1;o>=s?a=e/n.height:a=t/n.width,a>1&&(a=Math.floor(a)),x.width=n.width*a*S,x.height=n.height*a*S,x.style.width=`${n.width*a}px`,x.style.height=`${n.height*a}px`,n.restore(),n.save(),n.scale(a*S,a*S),q()}window.addEventListener("resize",k);n.setGameSize=function(i,t){this.width=i,this.height=t,k()};n.clear=function(i){this.fillStyle=i,this.clearRect(0,0,n.width,n.height),this.fillRect(0,0,n.width,n.height)};n.drawLine=function(i,t,e,s){this.beginPath(),this.moveTo(i,t),this.lineTo(e,s),this.closePath(),this.stroke()};n.drawCircle=function(i,t,e){this.beginPath(),this.arc(i,t,e,0,E),this.closePath(),this.stroke()};n.fillCircle=function(i,t,e){this.beginPath(),this.arc(i,t,e,0,E),this.closePath(),this.fill()};n.tintTexture=function(i,t){const e=document.createElement("canvas");e.width=i.width,e.height=i.height;const s=e.getContext("2d");s.drawImage(i,0,0),s.globalCompositeOperation="source-in",s.fillStyle=t,s.fillRect(0,0,e.width,e.height);const o=e.toDataURL(),a=new Image(e.width,e.height);return a.src=o,s.globalCompositeOperation="source-in",a};const P={Space:"space",Enter:"enter",ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",KeyW:"w",KeyA:"a",KeyS:"s",KeyD:"d",KeyQ:"q",KeyE:"e",Digit1:"one",Digit2:"two",Digit3:"three",Digit4:"four",Digit5:"five"};class K{constructor(){r(this,"mouseX",0);r(this,"mouseY",0);r(this,"keys",{});r(this,"mouseButton",[!1,!1]);for(const t in P)this.keys[P[t]]=[!1,!1];window.addEventListener("keydown",t=>{t.preventDefault();const e=P[t.code];e&&(this.keys[e][0]=!0)}),window.addEventListener("keyup",t=>{t.preventDefault();const e=P[t.code];e&&(this.keys[e][0]=!1)}),n.canvas.addEventListener("mousemove",t=>{t.preventDefault();const e=n.width/n.canvas.clientWidth,s=n.canvas.getClientRects()[0];return this.mouseX=(t.clientX-s.x)*e,this.mouseY=(t.clientY-s.y)*e,!1}),n.canvas.addEventListener("mousedown",t=>(t.preventDefault(),t.button===0&&(this.mouseButton[0]=!0),!1)),n.canvas.addEventListener("mouseup",t=>(t.preventDefault(),t.button===0&&(this.mouseButton[0]=!1),!1))}newFrame(){for(const t in this.keys)this.keys[t][1]=this.keys[t][0];this.mouseButton[1]=this.mouseButton[0]}mouseIsPressed(){return!!this.mouseButton[0]}mouseIsJustPressed(){return!!(this.mouseButton[0]&&!this.mouseButton[1])}mouseIsJustReleased(){return!!(!this.mouseButton[0]&&this.mouseButton[1])}keyIsPressed(...t){if(t.length>0){for(let e=0;e<t.length;++e)if(this.keys[t[e]][0])return!0}else for(const e in this.keys)if(this.keys[e][0])return!0;return!1}keyIsJustPressed(...t){if(t.length>0){for(let e=0;e<t.length;++e)if(this.keys[t[e]][0]&&!this.keys[t[e]][1])return!0}else for(const e in this.keys)if(this.keys[e][0]&&!this.keys[e][1])return!0;return!1}keyIsJustReleased(...t){if(t.length>0){for(let e=0;e<t.length;++e)if(!this.keys[t[e]][0]&&this.keys[t[e]][1])return!0}else for(const e in this.keys)if(!this.keys[e][0]&&this.keys[e][1])return!0;return!1}}const y=new K;class V{constructor(){r(this,"time",0);r(this,"slowdown",1);r(this,"dt",1/60)}deltaTime(){return this.dt*this.slowdown}}const p=new V;class z{constructor(t,e){r(this,"loopTimerID",0);r(this,"lastFrameTime");r(this,"states",[]);r(this,"shouldCallResume",!1);r(this,"resumeArgs");n.setGameSize(t,e),this.lastFrameTime=performance.now()}run(t){this.states.push(t),this.states[this.states.length-1].start(),this.update()}quit(){var t;do(t=this.states.pop())==null||t.end();while(this.states.length>0);window.cancelAnimationFrame(this.loopTimerID),document.removeChild(n.canvas)}pushState(t,e){this.states[this.states.length-1].pause(),this.states.push(t),this.shouldCallResume=!1,t.start(e)}popState(t){var e;this.states.length>1?((e=this.states.pop())==null||e.end(),this.shouldCallResume=!0,this.resumeArgs=t):console.error("Trying to pop the last game state of the state stack!")}peekState(){return this.states[this.states.length-1]}update(){this.loopTimerID=window.requestAnimationFrame(()=>this.update());const t=performance.now(),e=(t-this.lastFrameTime)/1e3;p.dt=e,p.time+=e,this.shouldCallResume&&(this.shouldCallResume=!1,this.states[this.states.length-1].resume(this.resumeArgs)),this.states[this.states.length-1].update(),n.clear("black");for(const s of this.states)s.draw();this.lastFrameTime=t,y.newFrame()}}class I{start(t){}end(){}resume(t){}pause(){}update(){}draw(){}}class ${constructor(){r(this,"clips");this.clips={},this.load("menu","./res/audio/music/menu.mp3",!0),this.load("pee","./res/audio/sfx/pee.mp3",!1),this.load("battle","./res/audio/music/battle.mp3",!0),this.load("deaf","./res/audio/sfx/deaf.mp3",!1),this.load("shield_up","./res/audio/sfx/shield_up.mp3",!1)}load(t,e,s,o=1){const a=new _.Howl({src:e,loop:s,volume:o});this.clips[t]=a}play(t,e=1){this.clips[t].volume(e),this.clips[t].play()}fadeOut(t,e){const s=this.clips[t];s.fade(s.volume(),0,e),s.on("fade",()=>{s.stop()})}}const w=new $;var h;(function(i){i[i.INVALID_TYPE=0]="INVALID_TYPE",i[i.PEAPROJECTILE=1]="PEAPROJECTILE",i[i.ENEMY=2]="ENEMY",i[i.SHADOW=3]="SHADOW",i[i.HURTABLE=4]="HURTABLE",i[i.TILEMAP=5]="TILEMAP",i[i.ANIMATOR=6]="ANIMATOR",i[i.COLLIDER=7]="COLLIDER",i[i.MOVER=8]="MOVER",i[i.TEXT=9]="TEXT",i[i.PLAYER=10]="PLAYER",i[i.UPGRADE=11]="UPGRADE",i[i.STATS=12]="STATS",i[i.CHEF=13]="CHEF",i[i.NUM_TYPES=14]="NUM_TYPES"})(h||(h={}));class f{constructor(t,e){r(this,"type",0);r(this,"active",!0);r(this,"entity");this.entity=t,this.type=e}awake(){}update(){}render(){}destroy(){}get world(){return this.entity.world}}const D={},R={};function Q(i,t){return new Promise((e,s)=>{const o=new Image;o.onload=()=>{D[i]=o,e(o)},o.onerror=()=>{s(t)},o.src=t})}function Z(i){return new Promise((t,e)=>{if(i.length===0){t();return}const s=[];i.forEach(o=>{s.push(Q(o[0],o[1]))}),Promise.all(s).then(()=>{t()}).catch(o=>{e(o)})})}function tt(i){return new Promise((t,e)=>{fetch(i,{method:"GET"}).then(s=>s.json()).then(s=>{t(s)}).catch(s=>{console.error(`Failed to load "${i}": ${s}`),e()})})}function N(i){return new Promise((t,e)=>{tt(i).then(s=>{for(const o in s)R[o]=s[o];t(R)}).catch(()=>{e()})})}class L extends f{constructor(t,e,s){super(s,h.ANIMATOR);r(this,"xOffset",0);r(this,"yOffset",0);r(this,"img");r(this,"sprite");r(this,"frameIndex",0);r(this,"frameTime",0);r(this,"current");r(this,"currentAnim");r(this,"columns");this.sprite=t,this.img=D[t.image],console.assert(this.img!==void 0,"Failed to load image for animation"),this.columns=this.sprite.width/this.sprite.frameWidth|0,this.current=e,this.currentAnim=this.sprite.anims[this.current]}play(t){t!==this.current&&(this.current=t,this.currentAnim=this.sprite.anims[t],this.frameTime=0,this.frameIndex=0)}awake(){this.frameIndex=0,this.frameTime=0}update(){const t=p.deltaTime()*1e3;for(this.frameTime+=t;this.frameTime>=this.currentAnim.framedurations[this.frameIndex];)this.frameTime-=this.currentAnim.framedurations[this.frameIndex],this.frameIndex+=1,this.frameIndex>=this.currentAnim.framedurations.length&&(this.frameIndex=0)}render(){if(this.entity.visible){const t=this.currentAnim.start+this.frameIndex,e=t%this.columns*this.sprite.frameWidth,s=(t/this.columns|0)*this.sprite.frameHeight;n.drawImage(this.img,e,s,this.sprite.frameWidth,this.sprite.frameHeight,this.entity.position.x+this.xOffset,this.entity.position.y+this.yOffset,this.sprite.frameWidth,this.sprite.frameHeight)}}}class A extends f{constructor(t,e,s){super(s,h.COLLIDER);r(this,"mask");r(this,"radius");r(this,"debugDraw",!1);this.radius=t,this.mask=e}render(){this.debugDraw&&(n.strokeStyle="red",n.drawCircle(this.entity.position.x,this.entity.position.y,this.radius))}collidesAt(t,e,s){return this.firstCollisionAt(t,e,s)!==null}firstCollisionAt(t,e,s){for(const o of this.world.all(h.COLLIDER))if((o.mask&t)!=0&&this.collidesWithAt(o,e,s))return o;return null}allCollisionsAt(t,e,s){const o=[];for(const a of this.world.all(h.COLLIDER))(a.mask&t)!=0&&this.collidesWithAt(a,e,s)&&o.push(a);return o}collidesWithAt(t,e,s){const o=this.entity.position.x+e-t.entity.position.x,a=this.entity.position.y+s-t.entity.position.y,l=o*o+a*a,u=this.radius+t.radius;return l<=u*u}}class U extends f{constructor(t){super(t,h.ENEMY)}}class T extends f{constructor(t,e,s){super(s,h.HURTABLE);r(this,"hurtBy");r(this,"collider");r(this,"onHurt");this.hurtBy=e,this.onHurt=t,this.collider=this.entity.first(h.COLLIDER)}update(){this.collider.collidesAt(this.hurtBy,0,0)&&(this.onHurt?this.onHurt():this.world.destroyEntity(this.entity))}}var d;(function(i){i[i.NONE=0]="NONE",i[i.SOLID=1]="SOLID",i[i.PLAYER=4]="PLAYER",i[i.ENEMY=8]="ENEMY",i[i.PLAYER_PROJECTILE=16]="PLAYER_PROJECTILE",i[i.ENEMY_PROJECTILE=32]="ENEMY_PROJECTILE",i[i.UPGRADE=64]="UPGRADE"})(d||(d={}));class et extends f{constructor(t,e){super(e,h.MOVER);r(this,"inputx",0);r(this,"inputy",0);r(this,"speed",64);r(this,"xError",0);r(this,"yError",0);r(this,"speedModifier",1);r(this,"collider");r(this,"onCollisionX");r(this,"onCollisionY");this.speed=t}update(){const t=p.deltaTime();let e=this.inputx,s=this.inputy;if(Math.abs(e)+Math.abs(s)>1){const o=Math.sqrt(e*e+s*s);e/=o,s/=o}this.moveX(e*this.speed*this.speedModifier*t),this.moveY(s*this.speed*this.speedModifier*t)}moveX(t){if(this.collider){if(this.xError+=t,t=Math.round(this.xError),Math.abs(t)>0){const e=Math.sign(t);for(;t!==0;){if(this.collider.collidesAt(d.SOLID,e,0)){this.onCollisionX?this.onCollisionX(this):this.stopX();break}this.entity.position.x+=e,t-=e,this.xError-=e}}}else this.entity.position.x+=t}moveY(t){if(this.collider){if(this.yError+=t,t=Math.round(this.yError),Math.abs(t)>0){const e=Math.sign(t);for(;t!==0;){if(this.collider.collidesAt(d.SOLID,0,e)){this.onCollisionY?this.onCollisionY(this):this.stopY();break}this.entity.position.y+=e,t-=e,this.xError-=e}}}else this.entity.position.y+=t}setSpeedModifier(t){this.speedModifier=t}stopX(){this.xError=0}stopY(){this.xError=0}}class it extends f{constructor(t,e){super(e,h.PEAPROJECTILE);r(this,"dx",0);r(this,"dy",0);r(this,"color");this.color=t,w.play("pee")}update(){const t=p.deltaTime();this.entity.position.x+=this.dx*t,this.entity.position.y+=this.dy*t,G(this.entity.position)>256&&this.world.destroyEntity(this.entity)}render(){n.fillStyle=this.color,n.fillCircle(this.entity.position.x,this.entity.position.y,2)}}class st extends f{constructor(t){super(t,h.PLAYER);r(this,"mover");r(this,"animator");r(this,"chef");r(this,"weaponCooldown",0);r(this,"firedWeapon",!1);this.mover=this.entity.first(h.MOVER),this.animator=this.entity.first(h.ANIMATOR),this.chef=this.entity.first(h.CHEF)}update(){if(this.chef.dying)this.mover.inputx=this.mover.inputy=0;else{const t=this.world.screenToWorld(y.mouseX,y.mouseY),e=t[0]-this.entity.position.x,s=t[1]-this.entity.position.y;this.entity.rotation=Math.atan2(s,e)+E/4,this.mover.inputx=this.mover.inputy=0,y.keyIsPressed("up","w")&&(this.mover.inputy-=1),y.keyIsPressed("down","s")&&(this.mover.inputy+=1),y.keyIsPressed("left","a")&&(this.mover.inputx-=1),y.keyIsPressed("right","d")&&(this.mover.inputx+=1),this.firedWeapon=!1,this.weaponCooldown<=0?y.mouseIsJustPressed()&&(this.chef.fire(),this.firedWeapon=!0):this.weaponCooldown-=p.deltaTime(),Math.abs(this.mover.inputx)+Math.abs(this.mover.inputy)>0?this.chef.animationState="move weapon1":this.chef.animationState="stand weapon1"}}}class rt extends f{constructor(t,e){super(e,h.UPGRADE);r(this,"collider");r(this,"upgradeType");this.collider=this.entity.first(h.COLLIDER),this.upgradeType=t}update(){this.collider.collidesAt(d.PLAYER,0,0)&&(this.world.first(h.PLAYER).chef.takeUpgrade(this.upgradeType),this.world.destroyEntity(this.entity))}}class ot extends f{constructor(t){super(t,h.SHADOW);r(this,"startX");r(this,"startY");r(this,"chef");this.startX=this.entity.position.x,this.startY=this.entity.position.y,this.chef=this.entity.first(h.CHEF)}}class O{constructor(){r(this,"shield",0);r(this,"speedModifier",1);r(this,"projectileSpeedModifier",1);r(this,"damageModifer",1);r(this,"slowOnHit",0);r(this,"stunChance",0);r(this,"invulnerabilityTime",0);r(this,"weaponSpreadModifier",1);r(this,"weaponCooldownModifier",1);r(this,"explosionDelay",0);r(this,"doubleShotChance",0);r(this,"explosionRangeModifier",1)}}class v extends f{constructor(t){super(t,h.STATS);r(this,"stats");this.stats=new O}apply(t){this.stats.shield+=t.shield,this.stats.speedModifier*=t.speedModifier,this.stats.projectileSpeedModifier*=t.projectileSpeedModifier,this.stats.damageModifer*=t.damageModifer,this.stats.slowOnHit+=t.slowOnHit,this.stats.stunChance+=t.stunChance,this.stats.invulnerabilityTime+=t.invulnerabilityTime,this.stats.weaponSpreadModifier*=t.weaponSpreadModifier,this.stats.weaponCooldownModifier*=t.weaponCooldownModifier,this.stats.explosionDelay+=t.explosionDelay,this.stats.doubleShotChance+=t.doubleShotChance,this.stats.explosionRangeModifier*=t.explosionRangeModifier,this.onApply()}onApply(){var t;(t=this.entity.first(h.MOVER))==null||t.setSpeedModifier(this.stats.speedModifier)}render(){this.stats.shield>0&&(n.strokeStyle="blue",n.drawCircle(this.entity.position.x,this.entity.position.y,8))}}class b{constructor(t,e){r(this,"name","crate");r(this,"animation","stand");r(this,"stats");r(this,"type");this.stats=this.setStats(t,e),this.type=t}setStats(t,e){let s=new O;switch(t){case c.shield:s.shield=e;case c.speed:s.speedModifier=e;case c.projectileSpeed:s.projectileSpeedModifier=e;case c.damage:s.damageModifer=e;case c.slow:s.slowOnHit=e;case c.stun:s.stunChance=e;case c.invulnerability:s.invulnerabilityTime=e;case c.weaponSpread:s.weaponSpreadModifier=e;case c.weaponCooldown:s.weaponCooldownModifier=e;case c.explosionDelay:s.explosionDelay=e;case c.doubleShot:s.doubleShotChance=e;case c.explosionRange:s.explosionRangeModifier=e}return s}}var c;(function(i){i[i.shield=0]="shield",i[i.speed=1]="speed",i[i.projectileSpeed=2]="projectileSpeed",i[i.damage=3]="damage",i[i.slow=4]="slow",i[i.stun=5]="stun",i[i.invulnerability=6]="invulnerability",i[i.weaponSpread=7]="weaponSpread",i[i.weaponCooldown=8]="weaponCooldown",i[i.explosionDelay=9]="explosionDelay",i[i.doubleShot=10]="doubleShot",i[i.explosionRange=11]="explosionRange"})(c||(c={}));class nt{constructor(t){r(this,"world");r(this,"cooldown",.1);this.world=t}fire(t,e,s,o,a){t+=Math.cos(s-E/4)*8,e+=Math.sin(s-E/4)*8,ht(t,e,s,128*o,a,this.world)}}class H extends f{constructor(t,e){super(e,h.CHEF);r(this,"animator");r(this,"weapon");r(this,"dying",!1);r(this,"animationState");r(this,"projectileMask");r(this,"upgradeType");r(this,"entityStats");this.projectileMask=t,this.animator=this.entity.first(h.ANIMATOR),this.weapon=new nt(this.world),this.animationState="stand weapon1",this.entityStats=this.entity.first(h.STATS)}fire(){this.weapon.fire(this.entity.position.x,this.entity.position.y,this.entity.rotation,this.entityStats.stats.projectileSpeedModifier,this.projectileMask)}takeUpgrade(t){this.upgradeType=t,this.playUpgradeSfx(t.type),this.entity.first(h.STATS).apply(t.stats)}playUpgradeSfx(t){switch(t){case c.shield:w.play("shield_up")}}getUpgrade(){if(this.upgradeType){const t=this.upgradeType;return this.upgradeType=void 0,t}}update(){this.dying?(this.animator.play("death"),this.animator.frameIndex===2&&this.animator.frameTime>=50&&this.world.destroyEntity(this.entity)):this.animator.play(this.animationState)}}function at(i,t,e,s){const o=s.addEntity(i,t);o.add(new A(6,d.PLAYER,o)),o.add(new et(64,o));const a=o.add(new v(o));a.stats=e;const l=o.add(new L(R.maincharacter,"stand weapon1",o));l.xOffset=-16,l.yOffset=-21;const u=()=>{a.stats.shield>0?a.stats.shield--:(m.chef.dying||w.play("deaf"),m.chef.dying=!0)};o.add(new T(u,d.ENEMY|d.ENEMY_PROJECTILE,o)),o.add(new H(d.PLAYER_PROJECTILE,o));const m=o.add(new st(o));return o}function ht(i,t,e,s,o,a){const l=a.addEntity(i,t),u=o===d.PLAYER_PROJECTILE?"lime":"#bc90da",m=l.add(new it(u,l));e-=E/4,m.dx=Math.cos(e)*s,m.dy=Math.sin(e)*s,l.add(new A(2,o,l));const M=o===d.PLAYER_PROJECTILE?d.ENEMY|d.PLAYER:d.PLAYER;return l.add(new T(null,M,l)),l}function lt(i,t,e){const s=e.addEntity(i,t);s.add(new A(8,d.ENEMY,s));const o=s.add(new L(R.slime,"move",s));return o.xOffset=-8,o.yOffset=-8,s.add(new T(null,d.PLAYER_PROJECTILE,s)),s.add(new U(s)),s}function F(i,t,e,s){const o=s.addEntity(i,t);o.add(new v(o));const a=o.add(new L(R[e.name],e.animation,o));return o.add(new A(8,d.UPGRADE,o)),o.add(new rt(e,o)),a.xOffset=-8,a.yOffset=-8,o}function dt(i,t,e){const s=e.addEntity(i,t);s.rotation=E/2,s.add(new A(6,d.ENEMY,s));const o=s.add(new v(s)),a=s.add(new L(R.maincharactershadow,"stand weapon1",s));a.xOffset=-16,a.yOffset=-21;const l=()=>{o.stats.shield>0?o.stats.shield--:(u.dying||w.play("deaf"),u.dying=!0)};s.add(new T(l,d.PLAYER_PROJECTILE,s)),s.add(new U(s));const u=s.add(new H(d.ENEMY_PROJECTILE,s));return s.add(new ot(s)),s}class ct{constructor(t,e,s,o,a,l){r(this,"x");r(this,"y");r(this,"rotation");r(this,"animationState");r(this,"upgrade");r(this,"shoot",!1);this.x=t,this.y=e,this.rotation=s,this.animationState=o,this.upgrade=a,this.shoot=l}}class ut{constructor(){r(this,"recordings",[]);r(this,"currentIndex",0);r(this,"backwards",!1);r(this,"firstPlayback",!0)}add(t){this.recordings.length<3600&&this.recordings.push(t)}get(t){return this.recordings[t]}getNext(){const t=this.recordings[this.currentIndex];return this.backwards?(this.currentIndex--,this.currentIndex==0&&(this.backwards=!1)):(this.currentIndex++,this.currentIndex==this.recordings.length-1&&(this.firstPlayback=!1,this.backwards=!0)),t}}class ft{constructor(t){r(this,"active",!0);r(this,"world");r(this,"position",{x:0,y:0});r(this,"rotation",0);r(this,"visible",!0);r(this,"components",[]);this.world=t}first(t){for(const e of this.components)if(e.type===t)return e;return null}add(t){return this.components.push(t),this.world.add(t),t}}class pt{constructor(){r(this,"entities",new Array);r(this,"components");r(this,"cameraX",0);r(this,"cameraY",0);this.components=[];for(let t=1;t<h.NUM_TYPES;++t)this.components.push([])}update(){for(const t of this.components)for(const e of t)e.active&&e.entity.active&&e.update()}render(){n.save(),n.translate(n.width/2-this.cameraX,n.height/2-this.cameraY),n.strokeStyle="white",n.drawCircle(0,0,64);for(const t of this.components)for(const e of t)e.active&&e.entity.active&&(n.save(),e.entity.rotation!==0&&(n.translate(e.entity.position.x,e.entity.position.y),n.rotate(e.entity.rotation),n.translate(-e.entity.position.x,-e.entity.position.y)),e.render(),n.restore());n.restore()}screenToWorld(t,e){return[t-n.width/2+this.cameraX,e-n.height/2+this.cameraY]}worldToScreen(t,e){return[t+n.width/2-this.cameraX,e+n.height/2-this.cameraY]}addEntity(t,e){const s=new ft(this);return s.position={x:t,y:e},this.entities.push(s),s}destroyEntity(t){t.active=!1;for(const e of t.components)this.destroy(e);for(let e=0;e<this.entities.length;++e)if(this.entities[e]===t){this.entities.splice(e,1);break}}first(t){return this.components[t].length>0?this.components[t-1][0]:null}all(t){return this.components[t-1]}add(t){return this.components[t.type-1].push(t),t.awake(),t}destroy(t){const e=this.components[t.type-1];for(let s=0;s<e.length;++s)if(e[s]===t){e.splice(s,1);break}t.destroy()}}class mt extends I{constructor(t,e){super();r(this,"duration");r(this,"t",0);r(this,"onFadeComplete");this.duration=t,this.onFadeComplete=e}update(){this.t+=p.deltaTime(),this.t>=this.duration&&(g.popState(),this.onFadeComplete&&this.onFadeComplete())}draw(){n.fillStyle=`rgba(0, 0, 0, ${this.t/this.duration}`,n.fillRect(0,0,n.width,n.height)}}class yt extends I{constructor(t){super();r(this,"duration");r(this,"t",0);this.duration=t}update(){this.t+=p.deltaTime(),this.t>=this.duration&&g.popState()}draw(){n.fillStyle=`rgba(0, 0, 0, ${1-this.t/this.duration}`,n.fillRect(0,0,n.width,n.height)}}class wt{constructor(){r(this,"upgradesTypes",[]);this.upgradesTypes.push(new b(c.speed,1.2)),this.upgradesTypes.push(new b(c.shield,1)),this.upgradesTypes.push(new b(c.projectileSpeed,1.5))}getRandomUpgrade(){const t=Math.floor(Math.random()*this.upgradesTypes.length);return this.upgradesTypes[t]}}class C extends I{constructor(t,e,s){super();r(this,"world");r(this,"player");r(this,"currentLevel",0);r(this,"recordings",[]);r(this,"shadows",[]);r(this,"currentRecording");r(this,"upgradeArray");r(this,"timer",60);r(this,"timeUntilNewUpgrade",10);if(this.world=new pt,this.player=at(0,0,s,this.world).first(h.PLAYER),this.currentLevel=t,this.recordings=e,this.currentRecording=new ut,this.upgradeArray=new wt,t===0)lt(0,-32,this.world);else{let o=0;for(let l=0;l<e.length;++l)o+=e.length-l,this.shadows.push([]);let a=32*e.length;for(let l=0;l<e.length;++l){const u=e.length-l;let m=0;for(let M=0;M<u;++M){const W=Math.cos(m)*a,j=Math.sin(m)*a;this.shadows[l].push(dt(W,j,this.world).first(h.SHADOW)),m+=E/u}a-=32}}F(Math.random()*64-32,Math.random()*64-32,this.upgradeArray.getRandomUpgrade(),this.world),console.log(t)}update(){if(!this.player.entity.active){g.popState();return}for(let e=0;e<this.recordings.length;++e){const s=this.recordings[e].getNext();for(const o of this.shadows[e])o.entity.active&&(o.entity.position.x=o.startX+s.x,o.entity.position.y=o.startY+s.y,o.chef.animationState=s.animationState,o.entity.rotation=s.rotation,this.recordings[e].firstPlayback&&s.upgrade&&o.chef.takeUpgrade(s.upgrade),s.shoot&&o.chef.fire())}this.world.update(),this.world.cameraX=this.player.entity.position.x,this.world.cameraY=this.player.entity.position.y;let t=this.player.chef.getUpgrade();this.currentRecording.add(new ct(this.player.entity.position.x,this.player.entity.position.y,this.player.entity.rotation,this.player.animator.current,t||null,this.player.firedWeapon)),this.world.all(h.ENEMY).length===0&&this.onNewLevel(),this.timeUntilNewUpgrade-=p.deltaTime(),this.timeUntilNewUpgrade<0&&(this.timeUntilNewUpgrade=10,F(Math.random()*64-32,Math.random()*64-32,this.upgradeArray.getRandomUpgrade(),this.world)),this.timer-=p.deltaTime(),this.timer<0&&(this.player.entity.first(h.CHEF).dying=!0)}draw(){n.fillStyle="white",n.fillText(Math.max(Math.floor(this.timer),0).toString(),n.width/10,n.height/10),this.world.render()}onNewLevel(){this.recordings.push(this.currentRecording),g.pushState(new mt(1,()=>{g.popState(),g.pushState(new C(++this.currentLevel,this.recordings,this.player.entity.first(h.STATS).stats)),g.pushState(new yt(1))}))}}class gt extends I{constructor(){super();r(this,"starting",!1);w.play("menu")}update(){y.mouseIsJustPressed()&&(this.starting=!0,g.pushState(new C(0,[],new O)),w.fadeOut("menu",500),w.play("battle",.7))}draw(){this.starting?n.clear("black"):(n.fillStyle="white",n.fillText("Click to start",n.width/2,n.height/2))}resume(t){this.starting=!1,w.fadeOut("battle",500),w.play("menu")}}const g=new z(200,600/4),Et=[Z([["crate","./res/crate.png"],["cthulhupotato","./res/cthulhupotato.png"],["maincharacter","./res/maincharacter.png"],["maincharactershadow","./res/maincharactershadow.png"],["pickups","./res/pickups.png"],["slime","./res/slime.png"]]),N("./res/sprites.json"),N("./res/sprites_shadow.json")];Promise.all(Et).then(i=>{g.run(new gt)});
